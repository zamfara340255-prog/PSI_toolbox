# -*- coding: utf-8 -*-import tkinter as tkimport tkinter.ttk as ttkimport mathfrom core.utils import tbfrom core.base_module import CalcModuleclass UnitConverterModule(CalcModule):    key = "units"    title = "Конвертер единиц"    def __init__(self, app):        super().__init__(app)                # --- ПЕРЕМЕННЫЕ ---        self.var_category = tk.StringVar(value="Длина и Расстояние")        self.var_search = tk.StringVar()        self.var_value = tk.StringVar(value="1")        self.var_from = tk.StringVar()        self.var_current_source = tk.StringVar(value="")        self.var_precision = tk.StringVar(value="Авто")        # --- БАЗА ДАННЫХ ЕДИНИЦ ---        self.cats = {            "Длина и Расстояние": [                ("Метр (м)", 1.0), ("Километр (км)", 1000.0), ("Сантиметр (см)", 0.01), ("Миллиметр (мм)", 0.001),                 ("Микрометр (мкм)", 1e-6), ("Нанометр (нм)", 1e-9), ("Ангстрем (Å)", 1e-10), ("Ферми (фм)", 1e-15),                ("Миля (сухопутная)", 1609.344), ("Миля (морская)", 1852.0),                ("Ярд (yd)", 0.9144), ("Фут (ft)", 0.3048), ("Дюйм (in)", 0.0254),                ("Хэнд (ладонь)", 0.1016), ("Спэн (пядь)", 0.2286),                ("Кабельтов (межд.)", 185.2), ("Кабельтов (США)", 219.456),                ("Лье (сухопутное)", 4828.03), ("Лье (морское)", 5556.0),                ("Верста", 1066.8), ("Сажень", 2.1336), ("Аршин", 0.7112),                 ("Локоть (русский)", 0.44), ("Вершок", 0.04445), ("Линия", 0.00254), ("Точка", 0.000254),                ("Астрономическая единица (а.е.)", 1.495979e11),                 ("Световой год (ly)", 9.4607e15), ("Парсек (pc)", 3.0857e16),                ("Световая секунда", 299792458.0), ("Световая минута", 1.7988e10),                ("Пункт (Didot)", 0.0003759), ("Пункт (Adobe/PostScript)", 0.00035277),                 ("Цицеро", 0.004512), ("Пайка (Pica)", 0.004233)            ],            "Масса (Вес)": [                ("Килограмм (кг)", 1.0), ("Грамм (г)", 0.001), ("Миллиграмм (мг)", 1e-6), ("Микрограмм (мкг)", 1e-9),                ("Тонна (метрическая)", 1000.0), ("Центнер", 100.0), ("Карат (метрич.)", 0.0002),                ("Фунт (lb, торговый)", 0.45359237), ("Унция (oz)", 0.0283495), ("Драхма (dr)", 0.00177185), ("Гран (gr)", 6.47989e-5),                ("Стоун (st)", 6.35029), ("Тонна (длинная, UK)", 1016.05), ("Тонна (короткая, US)", 907.185),                ("Пуд", 16.3805), ("Берковец", 163.805), ("Фун (русский)", 0.4095), ("Лот", 0.012797), ("Золотник", 0.004266), ("Доля", 4.44e-5),                ("Атомная единица массы (u)", 1.66054e-27), ("Масса электрона", 9.10938e-31), ("Масса протона", 1.67262e-27),                ("Масса Земли", 5.972e24), ("Масса Солнца", 1.989e30)            ],            "Объем и Вместимость": [                ("Кубический метр (м³)", 1.0), ("Литр (л)", 0.001), ("Миллилитр (мл)", 1e-6),                 ("Куб. сантиметр (см³)", 1e-6), ("Куб. миллиметр (мм³)", 1e-9),                ("Галлон (US, жидкий)", 0.00378541), ("Галлон (UK)", 0.00454609),                 ("Кварта (US)", 0.00094635), ("Пинта (US)", 0.000473176), ("Пинта (UK)", 0.000568261),                ("Жидкая унция (US)", 2.9574e-5), ("Жидкая унция (UK)", 2.8413e-5),                ("Баррель (нефтяной)", 0.158987), ("Баррель (US, сухой)", 0.115627),                ("Куб. ярд", 0.764555), ("Куб. фут", 0.0283168), ("Куб. дюйм", 1.6387e-5),                ("Стакан (метрич., 250)", 0.00025), ("Стакан (US)", 0.000236588),                ("Столовая ложка (метрич.)", 1.5e-5), ("Чайная ложка (метрич.)", 5e-6),                ("Бочка", 0.4918), ("Ведро", 0.012299), ("Штоф", 0.0012299), ("Чарка", 0.000123), ("Шкалик", 6.15e-5)            ],            "Площадь": [                ("Кв. метр (м²)", 1.0), ("Кв. километр (км²)", 1e6), ("Кв. сантиметр (см²)", 0.0001),                ("Гектар (га)", 10000.0), ("Сотка (ар)", 100.0),                 ("Кв. миля", 2.58999e6), ("Акр", 4046.86), ("Руд", 1011.71),                ("Кв. ярд", 0.836127), ("Кв. фут", 0.092903), ("Кв. дюйм", 0.00064516),                ("Десятина (казенная)", 10925.0), ("Барн (ядерная физ.)", 1e-28)            ],            "Время": [                ("Секунда (с)", 1.0), ("Миллисекунда (мс)", 0.001), ("Микросекунда (мкс)", 1e-6), ("Наносекунда (нс)", 1e-9),                ("Минута", 60.0), ("Час", 3600.0), ("Сутки", 86400.0), ("Неделя", 604800.0),                ("Год (365 дней)", 3.1536e7), ("Год (високосный)", 3.16224e7), ("Год (юлианский)", 3.15576e7),                ("Век (100 лет)", 3.15576e9), ("Тысячелетие", 3.15576e10),                ("Фортнайт (2 недели)", 1.2096e6), ("Академический час", 2700.0)            ],            "Скорость": [                ("Метр в секунду (м/с)", 1.0), ("Километр в час (км/ч)", 0.277778),                 ("Миля в час (mph)", 0.44704), ("Фут в секунду (fps)", 0.3048),                ("Узел (kn)", 0.514444), ("Мах (звук, стд. атм.)", 340.29),                ("Скорость света (c)", 299792458.0), ("Первая космическая (Земля)", 7900.0)            ],            "Информация (Объем)": [                ("Бит (bit)", 0.125), ("Байт (Byte)", 1.0),                ("Килобайт (KB)", 1024), ("Мегабайт (MB)", 1048576),                 ("Гигабайт (GB)", 1.07374e9), ("Терабайт (TB)", 1.09951e12), ("Петабайт (PB)", 1.1259e15),                ("Дискета 3.5 (1.44 MB)", 1474560), ("CD-ROM (700 MB)", 734003200), ("DVD-R (4.7 GB)", 4.7e9),                ("Blu-ray (SL, 25 GB)", 2.5e10)            ],            "Передача данных (Скорость)": [                ("Бит в секунду (bps)", 1.0),                ("Килобит/с (Kbps)", 1000.0), ("Мегабит/с (Mbps)", 1e6), ("Гигабит/с (Gbps)", 1e9),                ("Байт в секунду (B/s)", 8.0), ("Килобайт/с (KB/s)", 8000.0), ("Мегабайт/с (MB/s)", 8e6)            ],            "Давление": [                ("Паскаль (Па)", 1.0), ("Гектопаскаль (гПа)", 100.0), ("Килпаскаль (кПа)", 1000.0), ("Мегапаскаль (МПа)", 1e6),                ("Бар", 100000.0), ("Атмосфера физическая (атм)", 101325.0), ("Атмосфера техническая (ат)", 98066.5),                ("Миллиметр рт.ст. (торр)", 133.322), ("Дюйм рт.ст.", 3386.39),                ("Метр водяного столба", 9806.65), ("Дюйм водяного столба", 249.089),                ("Фунт на кв. дюйм (psi)", 6894.76), ("Кси (ksi)", 6.89476e6)            ],            "Температура": [                 ("Цельсий (°C)", "C"), ("Фаренгейт (°F)", "F"), ("Кельвин (K)", "K"),                 ("Ранкин (°R)", "R"), ("Реомюр (°Re)", "Re")            ],            "Энергия и Работа": [                ("Джоуль (Дж)", 1.0), ("Килоджоуль (кДж)", 1000.0), ("Мегаджоуль (МДж)", 1e6),                ("Калория (межд.)", 4.1868), ("Килокалория (ккал)", 4186.8), ("Термия (th)", 4.1868e6),                ("Ватт-час (Вт·ч)", 3600.0), ("Киловатт-час (кВт·ч)", 3.6e6),                ("Электронвольт (эВ)", 1.60217e-19),                 ("Британская терм. ед. (BTU)", 1055.06), ("Тротиловый эквивалент (кг)", 4.184e6),                ("Эрг", 1e-7), ("Фут-фунт силы", 1.35582)            ],            "Мощность": [                ("Ватт (Вт)", 1.0), ("Киловатт (кВт)", 1000.0), ("Мегаватт (МВт)", 1e6),                 ("Милливатт (мВт)", 0.001), ("Микроватт (мкВт)", 1e-6),                ("Лошадиная сила (метрич.)", 735.499), ("Лошадиная сила (электр.)", 746.0), ("Лошадиная сила (мех., hp)", 745.7),                ("Котловая л.с.", 9809.5),                ("дБм (dBm)", "dBm"), ("дБВт (dBW)", "dBW"),                ("Калорий в час", 1.163), ("БТЕ в час (BTU/h)", 0.293071)            ],            "Сила": [                ("Ньютон (Н)", 1.0), ("Килоньютон (кН)", 1000.0),                 ("Килограмм-сила (кгс)", 9.80665), ("Грамм-сила (гс)", 0.00980665),                ("Тонна-сила (тс)", 9806.65),                ("Фунт-сила (lbf)", 4.44822), ("Унция-сила", 0.278014),                ("Дина (dyn)", 1e-5), ("Паундаль (pdl)", 0.138255)            ],            "Углы": [                ("Градус (°)", 1.0), ("Радиан (рад)", 57.29578),                 ("Град (гон)", 0.9), ("Оборот (цикл)", 360.0),                ("Угловая минута (')", 1/60.0), ("Угловая секунда (\")", 1/3600.0),                ("Румб", 11.25), ("Секстант", 60.0)            ],            "Электрический заряд": [                ("Кулон (Кл)", 1.0), ("Милликулон (мКл)", 0.001), ("Микрокулон (мкКл)", 1e-6),                ("Ампер-час (А·ч)", 3600.0), ("Миллиампер-час (мА·ч)", 3.6),                ("Фарадей (F)", 96485.3), ("Заряд электрона (e)", 1.60217e-19)            ],            "Сопротивление": [                ("Ом (Ω)", 1.0), ("Килоом (кОм)", 1e3), ("Мегаом (МОм)", 1e6), ("Гигаом (ГОм)", 1e9),                ("Миллиом (мОм)", 0.001), ("Микроом (мкОм)", 1e-6),                ("Сименс (обратный Ом)", "inv")            ],            "Емкость (Электро)": [                ("Фарад (Ф)", 1.0), ("Миллифарад (мФ)", 1e-3), ("Микрофарад (мкФ)", 1e-6),                 ("Нанофарад (нФ)", 1e-9), ("Пикофарад (пФ)", 1e-12), ("Фемтофарад (фФ)", 1e-15)            ],            "Индуктивность": [                ("Генри (Гн)", 1.0), ("Миллигенри (мГн)", 1e-3), ("Микрогенри (мкГн)", 1e-6),                 ("Наногенри (нГн)", 1e-9), ("Пикогенри (пГн)", 1e-12)            ],            "Расход топлива": [                ("Литров на 100 км (л/100км)", "inv_l100"),                 ("Километров на литр (км/л)", 1.0),                ("Миль на галлон США (MPG US)", 0.425144), ("Миль на галлон UK (MPG UK)", 0.354006)            ],            "Радиация (Активность)": [                ("Беккерель (Бк)", 1.0), ("Кюри (Ci)", 3.7e10), ("Резерфорд (Rd)", 1e6),                ("Распадов в минуту (dpm)", 0.0166667)            ],            "Радиация (Экспозиц. доза)": [                ("Кулон на кг (Кл/кг)", 1.0), ("Рентген (Р)", 2.58e-4)            ],            "Радиация (Эквивалент. доза)": [                ("Зиверт (Зв)", 1.0), ("Миллизиверт (мЗв)", 0.001), ("Микрозиверт (мкЗв)", 1e-6),                ("Бэр (rem)", 0.01), ("Миллибэр", 1e-5)            ],            "Магнитная индукция": [                ("Тесла (Тл)", 1.0), ("Гаусс (Гс)", 1e-4), ("Микротесла (мкТл)", 1e-6), ("Гамма", 1e-9)            ],            "Напряжение": [                ("Вольт (В)", 1.0), ("мВ", 0.001), ("кВ", 1000.0), ("мкВ", 1e-6), ("дБмкВ (dBuV)", "dBuV")            ],            "Ток": [                ("Ампер (А)", 1.0), ("мА", 0.001), ("мкА", 1e-6), ("кА", 1000.0), ("Био (Bi)", 10.0)            ],            "Частота": [                ("Герц (Гц)", 1.0), ("кГц", 1e3), ("МГц", 1e6), ("ГГц", 1e9), ("ТГц", 1e12),                ("Оборотов в минуту (об/мин)", 0.0166667), ("Радиан в секунду", 0.159155)            ]        }    def toolbar_actions(self):        return []    def build_ui(self, parent):        self.frame = tb.Frame(parent)        self.build_converter_ui(self.frame)        return self.frame    def build_converter_ui(self, parent):        pad = 20        main_box = tb.Frame(parent)        main_box.pack(fill="both", expand=True, padx=pad, pady=pad)        # --- ЛЕВАЯ КОЛОНКА ---        left_panel = tb.Labelframe(main_box, text="Входные данные", padding=pad)        left_panel.pack(side="left", fill="y", padx=(0, 20))        tb.Label(left_panel, text="Поиск категории:", font=("Segoe UI", 9)).pack(anchor="w", pady=(0, 2))        search_entry = tb.Entry(left_panel, textvariable=self.var_search, font=("Segoe UI", 9))        search_entry.pack(fill="x", pady=(0, 10))        search_entry.bind("<KeyRelease>", self.filter_categories)        tb.Label(left_panel, text="Категория:", font=("Segoe UI", 9)).pack(anchor="w", pady=(0, 2))        self.cb_cat = tb.Combobox(left_panel, textvariable=self.var_category,                              values=sorted(list(self.cats.keys())), state="readonly", font=("Segoe UI", 9), width=22)        self.cb_cat.pack(fill="x", pady=(0, 10))        self.cb_cat.bind("<<ComboboxSelected>>", self.update_units_list)        tb.Label(left_panel, text="Значение:", font=("Segoe UI", 9)).pack(anchor="w", pady=(0, 2))        entry_val = tb.Entry(left_panel, textvariable=self.var_value, font=("Segoe UI", 10))        entry_val.pack(fill="x", pady=(0, 10))        entry_val.bind("<KeyRelease>", lambda e: self.calculate())        tb.Label(left_panel, text="Исходная единица:", font=("Segoe UI", 9)).pack(anchor="w", pady=(0, 2))        self.cb_from = tb.Combobox(left_panel, textvariable=self.var_from, state="readonly", font=("Segoe UI", 9))        self.cb_from.pack(fill="x", pady=(0, 10))        self.cb_from.bind("<<ComboboxSelected>>", lambda e: self.calculate())        tb.Label(left_panel, text="Округление:", font=("Segoe UI", 9)).pack(anchor="w", pady=(0, 2))        cb_prec = tb.Combobox(left_panel, textvariable=self.var_precision, values=["Авто", "0", "1", "2", "3", "4", "5", "6", "8", "10"], state="readonly", font=("Segoe UI", 9))        cb_prec.pack(fill="x", pady=(0, 15))        cb_prec.bind("<<ComboboxSelected>>", lambda e: self.calculate())        tb.Button(left_panel, text="ПЕРЕСЧИТАТЬ", command=self.calculate, bootstyle="primary", width=15).pack(fill="x", pady=10)        source_frame = tb.Frame(left_panel, bootstyle="primary", padding=10)        source_frame.pack(fill="x", pady=(20, 0))        tb.Label(source_frame, text="КОНВЕРТИРУЕМ:", font=("Segoe UI", 8), bootstyle="inverse-primary").pack(anchor="w")        tb.Label(source_frame, textvariable=self.var_current_source, font=("Segoe UI", 14, "bold"), bootstyle="inverse-primary", wraplength=180).pack(anchor="w")        # --- ПРАВАЯ КОЛОНКА ---        right_panel = tb.Labelframe(main_box, text="Результаты конвертации", padding=pad)        right_panel.pack(side="right", fill="both", expand=True)        style = ttk.Style()        style.configure("Big.Treeview", font=('Segoe UI', 13), rowheight=35)         style.configure("Big.Treeview.Heading", font=('Segoe UI', 11, 'bold'))        self.tree = ttk.Treeview(right_panel, columns=("unit", "value"), show="headings", style="Big.Treeview")        self.tree.heading("unit", text="Единица измерения", anchor="w")        self.tree.heading("value", text="Значение", anchor="e")        self.tree.column("unit", width=250, minwidth=150, anchor="w")        self.tree.column("value", width=250, minwidth=150, anchor="e")         self.tree.tag_configure('odd', background='#f7f7f7'); self.tree.tag_configure('even', background='#ffffff')             scrollbar = tb.Scrollbar(right_panel, orient="vertical", command=self.tree.yview)        self.tree.configure(yscrollcommand=scrollbar.set)        scrollbar.pack(side="right", fill="y")        self.tree.pack(side="left", fill="both", expand=True)        self.update_units_list()    # --- ЛОГИКА ---    def filter_categories(self, event):        search_text = self.var_search.get().lower()        all_cats = sorted(list(self.cats.keys()))        if not search_text: self.cb_cat['values'] = all_cats        else:            filtered = [c for c in all_cats if search_text in c.lower()]            self.cb_cat['values'] = filtered            if filtered: self.cb_cat.current(0); self.update_units_list()    def update_units_list(self, event=None):        cat = self.var_category.get()        if cat in self.cats:            units = [u[0] for u in self.cats[cat]]            self.cb_from['values'] = units            if self.var_from.get() not in units and units: self.var_from.set(units[0])            elif not self.var_from.get() and units: self.var_from.set(units[0])            self.calculate()    def _get_factor(self, cat, unit_name):        for u, f in self.cats[cat]:            if u == unit_name: return f        return 1.0    def calculate(self):        for item in self.tree.get_children(): self.tree.delete(item)        try:            val_str = self.var_value.get().replace(",", ".")            if not val_str: self.var_current_source.set("---"); return            val = float(val_str)            cat = self.var_category.get()            u_from = self.var_from.get()            self.var_current_source.set(f"{val} {u_from}")            fact_from = self._get_factor(cat, u_from)            base_val = 0.0            if cat == "Температура":                if "°C" in u_from: base_val = val                elif "°F" in u_from: base_val = (val - 32) * 5/9                elif "K" in u_from: base_val = val - 273.15                elif "°R" in u_from: base_val = (val - 491.67) * 5/9                elif "°Re" in u_from: base_val = val * 1.25            elif cat == "Мощность" and type(fact_from) == str:                 if "dBm" in u_from: base_val = 10 ** ((val - 30) / 10)                elif "dBW" in u_from: base_val = 10 ** (val / 10)            elif cat == "Напряжение" and type(fact_from) == str:                  if "dBuV" in u_from: base_val = 10 ** ((val - 120) / 20)            elif cat == "Расход топлива" and fact_from == "inv_l100":                 if val > 0: base_val = 100 / val                 else: base_val = 0            elif cat == "Сопротивление" and fact_from == "inv":                 if val > 0: base_val = 1 / val                 else: base_val = 0            else:                if isinstance(fact_from, (int, float)): base_val = val * fact_from                else: base_val = val             row_idx = 0            prec_mode = self.var_precision.get()            for u_name, u_fact in self.cats[cat]:                if u_name == u_from: continue                 res, is_error = 0.0, False                                if cat == "Температура":                    if "°C" in u_name: res = base_val                    elif "°F" in u_name: res = base_val * 9/5 + 32                    elif "K" in u_name: res = base_val + 273.15                    elif "°R" in u_name: res = (base_val + 273.15) * 1.8                    elif "°Re" in u_name: res = base_val * 0.8                elif cat == "Мощность" and type(u_fact) == str:                    if base_val <= 0: is_error = True; res_str = "-∞"                    else:                        if "dBm" in u_name: res = 10 * math.log10(base_val) + 30                        elif "dBW" in u_name: res = 10 * math.log10(base_val)                elif cat == "Напряжение" and type(u_fact) == str:                    if base_val <= 0: is_error = True; res_str = "-∞"                    else:                        if "dBuV" in u_name: res = 20 * math.log10(base_val) + 120                elif cat == "Расход топлива" and u_fact == "inv_l100":                    if base_val > 0: res = 100 / base_val                    else: res = 0                elif cat == "Сопротивление" and u_fact == "inv":                    if base_val > 0: res = 1 / base_val                    else: res = 0                else:                    if isinstance(u_fact, (int, float)): res = base_val / u_fact                    else: res = 0                 if not is_error:                    if prec_mode == "Авто":                        if abs(res) < 1e-6 or abs(res) >= 1e9: res_str = f"{res:.6e}"                        else: res_str = f"{res:.8f}".rstrip('0').rstrip('.')                    else:                        try: p = int(prec_mode); res_str = f"{res:.{p}f}"                        except: res_str = str(res)                    if res_str == "" or res_str == ".": res_str = "0"                tag = 'even' if row_idx % 2 == 0 else 'odd'                self.tree.insert("", "end", values=(u_name, res_str), tags=(tag,))                row_idx += 1        except ValueError: self.var_current_source.set("Ошибка")        except Exception as e: print(f"Calc error: {e}")