# -*- coding: utf-8 -*-import tkinter as tkimport mathfrom core.utils import tb, Cfrom core.base_module import CalcModuleclass MicrostripModule(CalcModule):    key = "microstrip"    title = "Микрополосковая линия"    def __init__(self, app):        super().__init__(app)                # Параметры подложки (Substrate)        self.var_er = tk.StringVar(value="4.4")   # FR-4        self.var_h = tk.StringVar(value="1.6")    # Высота, мм        self.var_t = tk.StringVar(value="0.035")  # Медь, мм        self.var_f = tk.StringVar(value="2.45")   # Частота, ГГц (НОВОЕ)                # Режим        self.var_mode = tk.IntVar(value=0)                # Целевые        self.var_target_z0 = tk.StringVar(value="50.0")        self.var_target_w = tk.StringVar(value="3.0")                # Результаты        self.var_res_main = tk.StringVar(value="-")        self.var_res_eff = tk.StringVar(value="-")         self.var_res_lambda = tk.StringVar(value="-") # Длина волны (НОВОЕ)        self.var_res_quarter = tk.StringVar(value="-") # 1/4 волны (НОВОЕ)                self.canvas = None    def toolbar_actions(self):        return []    def build_ui(self, parent):        self.frame = tb.Frame(parent)        pad = 20                paned = tb.Frame(self.frame)        paned.pack(fill="both", expand=True, padx=pad, pady=pad)                # --- ЛЕВАЯ ПАНЕЛЬ ---        left = tb.Labelframe(paned, text="Параметры подложки (PCB)", padding=20)        left.pack(side="left", fill="y", padx=(0, 20))                # Er        tb.Label(left, text="Диэлектрическая проницаемость (εr):", font=("Segoe UI", 9)).pack(anchor="w")        tb.Entry(left, textvariable=self.var_er).pack(fill="x", pady=(0, 5))                btn_fr = tb.Frame(left)        btn_fr.pack(fill="x", pady=(0, 15))        tb.Button(btn_fr, text="FR-4 (4.4)", command=lambda: self.set_mat(4.4), bootstyle="outline", width=8).pack(side="left", padx=(0,5))        tb.Button(btn_fr, text="RO4003 (3.55)", command=lambda: self.set_mat(3.55), bootstyle="outline", width=12).pack(side="left")        # H        tb.Label(left, text="Толщина диэлектрика (H), мм:", font=("Segoe UI", 9)).pack(anchor="w")        tb.Entry(left, textvariable=self.var_h).pack(fill="x", pady=(0, 15))        # T        tb.Label(left, text="Толщина меди (T), мм:", font=("Segoe UI", 9)).pack(anchor="w")        tb.Entry(left, textvariable=self.var_t).pack(fill="x", pady=(0, 5))                btn_cu = tb.Frame(left)        btn_cu.pack(fill="x", pady=(0, 15))        tb.Button(btn_cu, text="18 мкм", command=lambda: self.var_t.set("0.018"), bootstyle="outline", width=8).pack(side="left", padx=(0,5))        tb.Button(btn_cu, text="35 мкм", command=lambda: self.var_t.set("0.035"), bootstyle="outline").pack(side="left")        # F (Частота) - ДОБАВЛЕНО        tb.Separator(left).pack(fill="x", pady=10)        tb.Label(left, text="Рабочая частота (F), ГГц:", font=("Segoe UI", 9, "bold")).pack(anchor="w")        tb.Entry(left, textvariable=self.var_f, bootstyle="info").pack(fill="x", pady=(0, 5))        # --- ПРАВАЯ ПАНЕЛЬ ---        right = tb.Frame(paned)        right.pack(side="right", fill="both", expand=True)                calc_box = tb.Labelframe(right, text="Параметры линии", padding=20)        calc_box.pack(fill="x", pady=(0, 20))                tb.Label(calc_box, text="Что рассчитываем?", font=("Segoe UI", 10, "bold")).pack(anchor="w")        r_frame = tb.Frame(calc_box)        r_frame.pack(fill="x", pady=(5, 15))        tb.Radiobutton(r_frame, text="Ширину дорожки (по Z0)", variable=self.var_mode, value=0, command=self.toggle_mode).pack(side="left", padx=(0, 20))        tb.Radiobutton(r_frame, text="Импеданс (по Ширине)", variable=self.var_mode, value=1, command=self.toggle_mode).pack(side="left")        self.lbl_input = tb.Label(calc_box, text="Целевой импеданс (Z0), Ом:", font=("Segoe UI", 9))        self.lbl_input.pack(anchor="w")        self.ent_input = tb.Entry(calc_box, textvariable=self.var_target_z0, font=("Consolas", 12))        self.ent_input.pack(fill="x", pady=(0, 15))                tb.Button(calc_box, text="РАССЧИТАТЬ", command=self.calculate, bootstyle="primary").pack(fill="x")        # --- РЕЗУЛЬТАТЫ ---        res_box = tb.Frame(right, padding=15, bootstyle="secondary")        res_box.pack(fill="x", pady=(0, 20))                # Главный результат        self.lbl_res_title = tb.Label(res_box, text="Ширина дорожки (W):", font=("Segoe UI", 12), bootstyle="inverse-secondary")        self.lbl_res_title.pack(anchor="w")        tb.Label(res_box, textvariable=self.var_res_main, font=("Consolas", 24, "bold"), bootstyle="inverse-secondary").pack(anchor="w", pady=(0, 10))                # Доп. параметры (E_eff, Lambda)        grid_res = tb.Frame(res_box, bootstyle="secondary")        grid_res.pack(fill="x")                # Колонка 1        c1 = tb.Frame(grid_res, bootstyle="secondary")        c1.pack(side="left", fill="x", expand=True)        tb.Label(c1, text="Эфф. проницаемость (ε_eff):", font=("Segoe UI", 9), bootstyle="inverse-secondary").pack(anchor="w")        tb.Label(c1, textvariable=self.var_res_eff, font=("Segoe UI", 11, "bold"), bootstyle="inverse-secondary").pack(anchor="w")        # Колонка 2 (Длина волны)        c2 = tb.Frame(grid_res, bootstyle="secondary")        c2.pack(side="left", fill="x", expand=True)        tb.Label(c2, text="Длина волны в линии (λg):", font=("Segoe UI", 9), bootstyle="inverse-secondary").pack(anchor="w")        tb.Label(c2, textvariable=self.var_res_lambda, font=("Segoe UI", 11, "bold"), bootstyle="inverse-secondary").pack(anchor="w")        # Колонка 3 (1/4 волны)        c3 = tb.Frame(grid_res, bootstyle="secondary")        c3.pack(side="left", fill="x", expand=True)        tb.Label(c3, text="1/4 волны (λ/4):", font=("Segoe UI", 9), bootstyle="inverse-secondary").pack(anchor="w")        tb.Label(c3, textvariable=self.var_res_quarter, font=("Segoe UI", 11, "bold", "underline"), bootstyle="warning-inverse").pack(anchor="w")        self.canvas = tk.Canvas(right, bg="white", height=200, bd=0, highlightthickness=0)        self.canvas.pack(fill="both", expand=True)        self.toggle_mode()        self.calculate()        return self.frame    def set_mat(self, val):        self.var_er.set(str(val))    def toggle_mode(self):        mode = self.var_mode.get()        if mode == 0:            self.lbl_input.config(text="Целевой импеданс (Z0), Ом:")            self.ent_input.configure(textvariable=self.var_target_z0)            self.lbl_res_title.config(text="Ширина дорожки (W):")        else:            self.lbl_input.config(text="Ширина дорожки (W), мм:")            self.ent_input.configure(textvariable=self.var_target_w)            self.lbl_res_title.config(text="Волновое сопротивление (Z0):")    def _get(self, var):        try: return float(var.get().replace(",", "."))        except: return None    def calculate(self):        try:            er = self._get(self.var_er)            h = self._get(self.var_h)            t = self._get(self.var_t)            freq_ghz = self._get(self.var_f) # Частота                        mode = self.var_mode.get()                        if not er or not h or not t: return            if er <= 0 or h <= 0: return            eff_val = 0.0                        # --- Hammerstad & Jensen Formulas ---            def calc_z0(w_val):                if w_val <= 0: return 0, 0                u = w_val / h                eff = ((er + 1) / 2) + ((er - 1) / 2) * (1 / math.sqrt(1 + 12/u))                if u <= 1:                    z = (60 / math.sqrt(eff)) * math.log(8/u + 0.25*u)                else:                    z = (120 * math.pi) / (math.sqrt(eff) * (u + 1.393 + 0.667 * math.log(u + 1.444)))                return z, eff            best_w = 0.0                        if mode == 1: # Ищем Z0                w = self._get(self.var_target_w)                if w is None: return                z0, eff_val = calc_z0(w)                self.var_res_main.set(f"{z0:.2f} Ом")                best_w = w            else: # Ищем W                target_z = self._get(self.var_target_z0)                if target_z is None: return                                low, high = 0.001, 100.0 * h                for _ in range(50):                    mid = (low + high) / 2                    z_curr, eff_curr = calc_z0(mid)                    if z_curr > target_z: low = mid                    else: high = mid                    best_w = mid                    eff_val = eff_curr                                self.var_res_main.set(f"{best_w:.3f} мм")            self.var_res_eff.set(f"{eff_val:.2f}")            self.draw_profile(best_w, h, t)            # --- РАСЧЕТ ДЛИНЫ ВОЛНЫ ---            if freq_ghz and freq_ghz > 0:                # C = 3e8 м/с = 300 мм/нс. Частота в ГГц (1e9).                # Lambda_0 [мм] = 300 / F[ГГц]                lambda_0_mm = 299.792 / freq_ghz                                # Lambda_g [мм] = Lambda_0 / sqrt(E_eff)                lambda_g_mm = lambda_0_mm / math.sqrt(eff_val)                                self.var_res_lambda.set(f"{lambda_g_mm:.1f} мм")                self.var_res_quarter.set(f"{lambda_g_mm/4:.1f} мм")            else:                self.var_res_lambda.set("-")                self.var_res_quarter.set("-")        except Exception as e:            print(f"Microstrip calc error: {e}")    def draw_profile(self, w, h, t):        c = self.canvas        c.delete("all")        W_canv = int(c['width']) if c['width'] != '0' else 400        H_canv = int(c['height']) if c['height'] != '0' else 200                center_x = W_canv / 2        base_y = H_canv - 40        scale_h = 60                 ratio = w / h        if ratio < 0.1: ratio = 0.1        if ratio > 8: ratio = 8                draw_w = ratio * scale_h        draw_h = scale_h        draw_t = 10                 # GND        c.create_rectangle(50, base_y, W_canv-50, base_y+10, fill="#d0d0d0", outline="gray")        c.create_text(center_x, base_y+20, text="GND", fill="gray", font=("Segoe UI", 8))                # Dielectric        dielect_color = "#f5f5dc"        c.create_rectangle(100, base_y - draw_h, W_canv-100, base_y, fill=dielect_color, outline="gray")                # Trace        trace_x1 = center_x - draw_w/2        trace_x2 = center_x + draw_w/2        c.create_rectangle(trace_x1, base_y - draw_h - draw_t, trace_x2, base_y - draw_h, fill="#b87333", outline="#8b4513")                # Dim H        dim_x = W_canv - 80        c.create_line(dim_x, base_y, dim_x, base_y - draw_h, arrow="both", fill="black")        c.create_text(dim_x + 15, base_y - draw_h/2, text=f"H={h}", font=("Segoe UI", 9))                # Dim W        dim_y = base_y - draw_h - draw_t - 15        c.create_line(trace_x1, dim_y, trace_x2, dim_y, arrow="both", fill="black")        c.create_text(center_x, dim_y - 10, text=f"W={w:.3f}", font=("Segoe UI", 9, "bold"))                # Label Er        c.create_text(130, base_y - draw_h/2, text=f"εr={self.var_er.get()}", fill="gray", font=("Segoe UI", 10))