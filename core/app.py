import tkinter as tkimport tkinter.ttk as ttkfrom typing import List, Dict, Typefrom tkinter import messageboxfrom core.utils import tb, TB_OK, APP_NAME, APP_VERSIONfrom core.base_module import CalcModuleclass PSIToolboxApp(tb.Window):    def __init__(self, modules: List[Type[CalcModule]]):        super().__init__() if not TB_OK else super().__init__(themename="flatly")        self.title(f"{APP_NAME} {APP_VERSION}")        self.geometry("1280x800")        self.minsize(1000, 600)                try: self.state("zoomed")        except: pass        self._modules_classes = modules        self._modules: Dict[str, CalcModule] = {}        self._active_key = None        self._build_shell()        self._build_menu()                for cls in self._modules_classes:            mod = cls(self)            self._modules[mod.key] = mod            self.listbox.insert(tk.END, mod.title)        if self._modules:            self.listbox.selection_set(0)            self.switch_to(list(self._modules.keys())[0])    def _build_shell(self):        pad = 10        root = tb.Frame(self)        root.pack(fill="both", expand=True, padx=pad, pady=pad)        self.pw = ttk.PanedWindow(root, orient="horizontal")        self.pw.pack(fill="both", expand=True)        self.nav = tb.Frame(self.pw)        self.work = tb.Frame(self.pw)                self.pw.add(self.nav, weight=1)        self.pw.add(self.work, weight=5)        self._nav_visible = True        # Панель навигации        nav_box = tb.Labelframe(self.nav, text="Инструменты", padding=pad)        nav_box.pack(fill="both", expand=True)                self.listbox = tk.Listbox(nav_box, borderwidth=0, highlightthickness=0, font=("Segoe UI", 10))        self.listbox.pack(fill="both", expand=True, pady=(0, 10))        self.listbox.bind("<<ListboxSelect>>", self._on_select)                self.toolbar = tb.Frame(nav_box)        self.toolbar.pack(fill="x")        # Рабочая область        self.main = tb.Frame(self.work)        self.main.pack(fill="both", expand=True)        # Лог        out = tb.Labelframe(self.work, text="Сообщения", padding=5)        out.pack(fill="x", pady=(pad, 0))        self.output_text = tk.Text(out, height=4, wrap="word", borderwidth=0, bg="#f0f0f0")        self.output_text.pack(fill="both", expand=True)        self.status_label = tb.Label(out, text="Готов", font=("Segoe UI", 9))        self.status_label.pack(anchor="w")    def _build_menu(self):        menubar = tk.Menu(self)        # МЕНЮ ФАЙЛ        file_menu = tk.Menu(menubar, tearoff=0)        file_menu.add_command(label="Сохранить проект...", command=lambda: self._call_mod("save_project"))        file_menu.add_command(label="Загрузить проект...", command=lambda: self._call_mod("load_project"))        file_menu.add_separator()        file_menu.add_command(label="Сохранить график (PNG)...", command=lambda: self._call_mod("save_plot"))        file_menu.add_separator()        file_menu.add_command(label="Выход", command=self.destroy)        menubar.add_cascade(label="Файл", menu=file_menu)        # МЕНЮ ВИД        view_menu = tk.Menu(menubar, tearoff=0)        view_menu.add_command(label="Скрыть/Показать меню", command=self.toggle_nav)        menubar.add_cascade(label="Вид", menu=view_menu)        self.config(menu=menubar)    def toggle_nav(self):        if self._nav_visible:            self.pw.forget(self.nav)            self._nav_visible = False        else:            self.pw.insert(0, self.nav, weight=1)            self._nav_visible = True    def _call_mod(self, method_name):        mod = self._modules.get(self._active_key)        if mod and hasattr(mod, method_name):            getattr(mod, method_name)()        else:            messagebox.showinfo("Инфо", "Для текущего модуля эта функция недоступна.")    def _on_select(self, e):        sel = self.listbox.curselection()        if not sel: return        key = list(self._modules.keys())[sel[0]]        self.switch_to(key)    def switch_to(self, key):        if key == self._active_key: return        for w in self.main.winfo_children(): w.destroy()                mod = self._modules[key]        f = mod.build_ui(self.main)        f.pack(fill="both", expand=True)                self._active_key = key        self._rebuild_toolbar(mod)        mod.on_show()    def _rebuild_toolbar(self, mod):        for w in self.toolbar.winfo_children(): w.destroy()        for txt, style, cb in mod.toolbar_actions():            tb.Button(self.toolbar, text=txt, bootstyle=style, command=cb).pack(fill="x", pady=2)    def set_result(self, txt, st_txt="Done", st_style="secondary"):        self.output_text.delete("1.0", tk.END)        self.output_text.insert(tk.END, txt)        self.status_label.config(text=st_txt, bootstyle=st_style)